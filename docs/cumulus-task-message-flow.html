
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Cumulus Task Message Flow Â· Cumulus Documentation</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="developing-workflow-tasks.html" />
    
    
    <link rel="prev" href="input_output.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="architecture.html">
            
                <a href="architecture.html">
            
                    
                    Architecture
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="deployment.html">
            
                <a href="deployment.html">
            
                    
                    Cumulus Deployment
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="create_bucket.html">
            
                <a href="create_bucket.html">
            
                    
                    Creating an S3 Bucket
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="iam_roles.html">
            
                <a href="iam_roles.html">
            
                    
                    Locating IAMs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="troubleshoot_deployment.html">
            
                <a href="troubleshoot_deployment.html">
            
                    
                    Troubleshooting Deployment
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="workflows.html">
            
                <a href="workflows.html">
            
                    
                    Cumulus Workflows
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="protocol.html">
            
                <a href="protocol.html">
            
                    
                    Protocol
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="input_output.html">
            
                <a href="input_output.html">
            
                    
                    Input & Ouptut
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4.3" data-path="cumulus-task-message-flow.html">
            
                <a href="cumulus-task-message-flow.html">
            
                    
                    Cumulus Task Message Flow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="developing-workflow-tasks.html">
            
                <a href="developing-workflow-tasks.html">
            
                    
                    Developing Workflow Tasks
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.4.1" data-path="lambda.html">
            
                <a href="lambda.html">
            
                    
                    Lambda Functions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4.2" data-path="docker.html">
            
                <a href="docker.html">
            
                    
                    Dockerization
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="workflow-configuration-how-to.html">
            
                <a href="workflow-configuration-how-to.html">
            
                    
                    Workflow Configuration How-to's
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="tasks.html">
            
                <a href="tasks.html">
            
                    
                    Tasks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="api.html">
            
                <a href="api.html">
            
                    
                    Cumulus API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="ems_reporting.html">
            
                <a href="ems_reporting.html">
            
                    
                    EMS Reporting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="doc_installation.html">
            
                <a href="doc_installation.html">
            
                    
                    Local Docs
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="adding-a-task.html">
            
                <a href="adding-a-task.html">
            
                    
                    Adding a task
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="team.html">
            
                <a href="team.html">
            
                    
                    Team
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Cumulus Task Message Flow</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="cumulus-tasks-message-flow">Cumulus Tasks: Message Flow</h1>
<p>Cumulus Tasks comprise Cumulus Workflows and are either AWS Lambda tasks or AWS Elastic Container Service (ECS) activities. Cumulus Tasks permit a payload as input to the main task application code. The task payload is additionally wrapped by the <a href="https://github.com/cumulus-nasa/cumulus-message-adapter" target="_blank">Cumulus Message Adapter</a>. The Cumulus Message Adapter supplies additional information supporting message templating and metadata management of these workflows.</p>
<p><img src="../images/cumulus-task-message-flow.png"></p>
<p>The steps in this flow are detailed in sections below.</p>
<h2 id="cumulus-message-format">Cumulus Message Format</h2>
<p>Cumulus Messages come in 2 flavors: The full <strong>Cumulus Message</strong> and the <strong>Cumulus Remote Message</strong>. The Cumulus Remote Message points to a full Cumulus Message stored in S3 because of size limitations.</p>
<p>A full <strong>Cumulus Message</strong> has the 4 following keys:</p>
<ul>
<li><strong><code>workflow_config</code>:</strong> Definition-time information to set up tasks. Optionally includes configuration for each task in the workflow, keyed by task name.</li>
<li><strong><code>cumulus_meta</code>:</strong> System runtime information that should generally not be touched outside of Cumulus library code or the Cumulus Message Adapter. Stores meta information about the workflow such as the state machine name and the current workflow execution&apos;s name. This information is used to look up the current active task. The name of the current active task is used to look up the corresponding task&apos;s config in <code>workflow_config</code>.</li>
<li><strong><code>meta</code>:</strong> Runtime information captured by the workflow operators. Stores execution-agnostic variables which can be re-used via templates in <code>workflow_config</code>.</li>
<li><strong><code>payload</code>:</strong> Payload is runtime information for the tasks.</li>
</ul>
<p>Here&apos;s a simple example of a Cumulus Message:</p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;workflow_config&quot;</span>: {
    <span class="hljs-string">&quot;Example&quot;</span>: {
      <span class="hljs-string">&quot;inlinestr&quot;</span>: <span class="hljs-string">&quot;prefix{meta.foo}suffix&quot;</span>,
      <span class="hljs-string">&quot;array&quot;</span>: <span class="hljs-string">&quot;{[$.meta.foo]}&quot;</span>,
      <span class="hljs-string">&quot;object&quot;</span>: <span class="hljs-string">&quot;{{$.meta}}&quot;</span>
    }
  },
  <span class="hljs-string">&quot;cumulus_meta&quot;</span>: {
    <span class="hljs-string">&quot;message_source&quot;</span>: <span class="hljs-string">&quot;sfn&quot;</span>,
    <span class="hljs-string">&quot;state_machine&quot;</span>: <span class="hljs-string">&quot;arn:aws:states:us-east-1:1234:stateMachine:MySfn&quot;</span>,
    <span class="hljs-string">&quot;execution_name&quot;</span>: <span class="hljs-string">&quot;MyExecution__id-1234&quot;</span>,
    <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;id-1234&quot;</span>
  },
  <span class="hljs-string">&quot;meta&quot;</span>: {
    <span class="hljs-string">&quot;foo&quot;</span>: <span class="hljs-string">&quot;bar&quot;</span>
  },
  <span class="hljs-string">&quot;payload&quot;</span>: {
    <span class="hljs-string">&quot;anykey&quot;</span>: <span class="hljs-string">&quot;anyvalue&quot;</span>
  }
}
</code></pre>
<p>A <strong>Cumulus Remote Message</strong> has only the keys <code>replace</code> and <code>cumulus_meta</code>.</p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;replace&quot;</span>: {
    <span class="hljs-string">&quot;Bucket&quot;</span>: <span class="hljs-string">&quot;cumulus-bucket&quot;</span>,
    <span class="hljs-string">&quot;Key&quot;</span>: <span class="hljs-string">&quot;my-large-event.json&quot;</span>
  },
  <span class="hljs-string">&quot;cumulus_meta&quot;</span>: {}
}
</code></pre>
<h2 id="cumulus-message-preparation">Cumulus Message Preparation</h2>
<p>The event coming into a Cumulus Task is assumed to be a Cumulus Message or Cumulus Remote Message and should first be handled by the functions described below before being passed to the task application code.</p>
<h4 id="preparation-step-1-fetch-remote-event">Preparation Step 1: Fetch remote event</h4>
<p>Fetch remote event will fetch the full event from S3 if the cumulus message includes a <code>replace</code> key.</p>
<p>Once &quot;my-large-event.json&quot; is fetched from S3, it&apos;s returned from the fetch remote event function. If no &quot;replace&quot; key is present, the event passed to the fetch remote event function is assumed to be a full Cumulus Message and returned as-is.</p>
<h4 id="preparation-step-2-fetch-step-function-config">Preparation Step 2: Fetch step function config</h4>
<p>Fetch step function config determines what current task is being executed. Note this is different from what lambda or activity is being executed, because the same lambda or activity can be used for different tasks. The current task name is used to load the appropriate configuration from the Cumulus Message&apos;s &apos;workflow_config&apos;.</p>
<h4 id="preparation-step-3-load-nested-event">Preparation Step 3: Load nested event</h4>
<p>Using the config returned from the previous step, load nested event resolves templates for the final config and input to send to the task&apos;s application code. Read more on URL Templating in the <a href="protocol.html#url-templating">Protocol section</a>.</p>
<h2 id="task-application-code">Task Application Code</h2>
<p>After message prep, the message passed to the task application code is of the form:</p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;input&quot;</span>: {},
  <span class="hljs-string">&quot;config&quot;</span>: {}
}
</code></pre>
<h2 id="create-next-message-functions">Create Next Message functions</h2>
<p>Whatever comes out of the task application code is used to construct an outgoing Cumulus Message.</p>
<h4 id="create-next-message-step-1-assign-outputs">Create Next Message Step 1: Assign outputs</h4>
<p>The config loaded from the <strong>Fetch step function config</strong> step may have a <code>cumulus_message</code> key. This can be used to &quot;dispatch&quot; fields from the task&apos;s application output to a destination in the final event output (via URL templating). Here&apos;s an example where the value of <code>input.anykey</code> would be dispatched as the value of <code>payload.out</code> in the final cumulus message:</p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;workflow_config&quot;</span>: {
    <span class="hljs-string">&quot;Example&quot;</span>: {
      <span class="hljs-string">&quot;bar&quot;</span>: <span class="hljs-string">&quot;baz&quot;</span>,
      <span class="hljs-string">&quot;cumulus_message&quot;</span>: {
        <span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;{{$.payload.input}}&quot;</span>,
        <span class="hljs-string">&quot;outputs&quot;</span>: [
          {
            <span class="hljs-string">&quot;source&quot;</span>: <span class="hljs-string">&quot;{{$.input.anykey}}&quot;</span>,
            <span class="hljs-string">&quot;destination&quot;</span>: <span class="hljs-string">&quot;{{$.payload.out}}&quot;</span>
          }
        ]
      }
    }
  },
  <span class="hljs-string">&quot;cumulus_meta&quot;</span>: {
    <span class="hljs-string">&quot;task&quot;</span>: <span class="hljs-string">&quot;Example&quot;</span>,
    <span class="hljs-string">&quot;message_source&quot;</span>: <span class="hljs-string">&quot;local&quot;</span>,
    <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;id-1234&quot;</span>
  },
  <span class="hljs-string">&quot;meta&quot;</span>: {
    <span class="hljs-string">&quot;foo&quot;</span>: <span class="hljs-string">&quot;bar&quot;</span>
  },
  <span class="hljs-string">&quot;payload&quot;</span>: {
    <span class="hljs-string">&quot;input&quot;</span>: {
      <span class="hljs-string">&quot;anykey&quot;</span>: <span class="hljs-string">&quot;anyvalue&quot;</span>
    }
  }
}
</code></pre>
<h4 id="create-next-message-step-2-store-remote-event">Create Next Message Step 2: Store remote event</h4>
<p><strong>Store remote event</strong> complements <strong>Fetch remote event:</strong> If the cumulus message is too big, it will be stored in S3 and the final output of the task will be Cumulus Remove Message - an object with only the <code>replace</code> and <code>cumulus_meta</code> keys. The <code>replace</code> key identifies where the large event has been stored in S3.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="input_output.html" class="navigation navigation-prev " aria-label="Previous page: Input & Ouptut">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="developing-workflow-tasks.html" class="navigation navigation-next " aria-label="Next page: Developing Workflow Tasks">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Cumulus Task Message Flow","level":"1.4.3","depth":2,"next":{"title":"Developing Workflow Tasks","level":"1.4.4","depth":2,"path":"docs/developing-workflow-tasks.md","ref":"docs/developing-workflow-tasks.md","articles":[{"title":"Lambda Functions","level":"1.4.4.1","depth":3,"path":"docs/lambda.md","ref":"docs/lambda.md","articles":[]},{"title":"Dockerization","level":"1.4.4.2","depth":3,"path":"docs/docker.md","ref":"docs/docker.md","articles":[]}]},"previous":{"title":"Input & Ouptut","level":"1.4.2","depth":2,"path":"docs/input_output.md","ref":"docs/input_output.md","articles":[]},"dir":"ltr"},"config":{"plugins":[],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Cumulus Documentation","gitbook":"*"},"file":{"path":"docs/cumulus-task-message-flow.md","mtime":"2018-06-06T19:12:32.364Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-06-06T19:13:48.423Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

